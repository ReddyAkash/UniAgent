<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniAgent - Authentication</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #00A9FF; --secondary-color: #89CFF3; --background-color: #0F172A;
            --surface-color: #1E293B; --text-color: #E2E8F0; --error-color: #F87171;
            --success-color: #34D399; --font-family: 'Inter', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family); background: var(--background-color); color: var(--text-color);
            display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden;
            background-image: radial-gradient(circle at 20% 20%, rgba(0, 169, 255, 0.1), transparent 30%),
                              radial-gradient(circle at 80% 80%, rgba(137, 207, 243, 0.1), transparent 30%);
        }
        .auth-container {
            width: 100%; max-width: 420px; background-color: var(--surface-color); padding: 2.5rem;
            border-radius: 1.5rem; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1); position: relative; overflow: hidden;
        }
        .auth-header { text-align: center; margin-bottom: 2rem; }
        .auth-header h1 { font-size: 2rem; font-weight: 700; color: #fff; margin-bottom: 0.5rem; }
        .auth-header p { color: var(--secondary-color); font-size: 1rem; }
        .form-group { margin-bottom: 1.25rem; position: relative; }
        .form-input {
            width: 100%; padding: 1rem; background-color: #334155; border: 1px solid #475569;
            border-radius: 0.75rem; color: var(--text-color); font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .form-input::placeholder { color: #94A3B8; }
        .form-input:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 169, 255, 0.3);
        }
        .error-message {
            color: var(--error-color); font-size: 0.875rem; padding-top: 0.5rem;
            display: none; min-height: 1.25rem;
        }
        .submit-btn {
            width: 100%; padding: 1rem; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border: none; border-radius: 0.75rem; color: #fff; font-size: 1rem; font-weight: 600;
            cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0, 169, 255, 0.2); }
        .mode-switcher { text-align: center; margin-top: 1.5rem; font-size: 0.9rem; color: #94A3B8; }
        .mode-switcher button {
            background: none; border: none; color: var(--primary-color);
            font-weight: 600; cursor: pointer; font-size: 0.9rem;
        }
        .mode-switcher button:hover { text-decoration: underline; }
        .dynamic-field {
            max-height: 0; overflow: hidden;
            transition: max-height 0.5s ease-out, margin-bottom 0.5s ease-out; margin-bottom: 0;
        }
        .auth-container.signup-mode .dynamic-field { max-height: 100px; margin-bottom: 1.25rem; }
        .message-box {
            position: fixed; top: 20px; left: 50%; transform: translate(-50%, -150%);
            padding: 1rem 2rem; border-radius: 0.75rem; color: #fff; font-weight: 600;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 1000;
            transition: transform 0.5s ease-in-out;
        }
        .message-box.show { transform: translate(-50%, 0); }
        .message-box.success { background-color: var(--success-color); }
        .message-box.error { background-color: var(--error-color); }
    </style>
</head>
<body>

<div class="auth-container" id="auth-container">
    <div class="auth-header">
            <h1 id="form-title">Create Account</h1>
            <p id="form-subtitle">Welcome to UniAgent</p>
        </div>
        <form id="auth-form" novalidate>
            <div class="form-group">
                <input type="text" id="userid" class="form-input" placeholder="User ID (e.g., 21MIS1128)" required>
                <div class="error-message" id="userid-error"></div>
            </div>
            <div class="form-group dynamic-field" id="username-group">
                <input type="text" id="username" class="form-input" placeholder="Username" required>
                <div class="error-message" id="username-error"></div>
            </div>
            <div class="form-group dynamic-field" id="email-group">
                <input type="email" id="email" class="form-input" placeholder="Student Email" required>
                <div class="error-message" id="email-error"></div>
            </div>
            <div class="form-group">
                <input type="password" id="password" class="form-input" placeholder="Password" required>
                <div class="error-message" id="password-error"></div>
            </div>
            <div class="form-group dynamic-field" id="confirm-password-group">
                <input type="password" id="confirm-password" class="form-input" placeholder="Confirm Password" required>
                <div class="error-message" id="confirm-password-error"></div>
            </div>
            <button type="submit" class="submit-btn" id="submit-btn">Sign Up</button>
        </form>
        <div class="mode-switcher">
            <span id="switcher-text">Already have an account?</span>
            <button id="mode-toggle-btn">Sign In</button>
        </div>
</div>

<div id="message-box" class="message-box"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const authContainer = document.getElementById('auth-container');
    const form = document.getElementById('auth-form');
    const modeToggleButton = document.getElementById('mode-toggle-btn');
    const useridInput = document.getElementById('userid');
    const usernameInput = document.getElementById('username');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirm-password');
    const formTitle = document.getElementById('form-title');
    const formSubtitle = document.getElementById('form-subtitle');
    const submitBtn = document.getElementById('submit-btn');
    const switcherText = document.getElementById('switcher-text');
    const messageBox = document.getElementById('message-box');
    const errorDivs = {
        userid: document.getElementById('userid-error'),
        username: document.getElementById('username-error'),
        email: document.getElementById('email-error'),
        password: document.getElementById('password-error'),
        confirmPassword: document.getElementById('confirm-password-error')
    };

    let currentMode = 'signup';

    const regex = {
        userid: /^\d{2}[A-Z]{3}\d{4,5}$/,
        email: /^[a-zA-Z0-9._%+-]+@vitstudent\.ac\.in$/,
        password: /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&]).{8,}$/
    };

    const updateUIForMode = () => {
        Object.values(errorDivs).forEach(div => div.style.display = 'none');
        form.reset();
        authContainer.classList.toggle('signup-mode', currentMode === 'signup');
        formTitle.textContent = currentMode === 'signup' ? 'Create Account' : 'Welcome Back';
        formSubtitle.textContent = currentMode === 'signup' ? 'Join the future of university assistance' : 'Sign in to access UniAgent';
        submitBtn.textContent = currentMode === 'signup' ? 'Sign Up' : 'Sign In';
        switcherText.textContent = currentMode === 'signup' ? 'Already have an account?' : "Don't have an account?";
        modeToggleButton.textContent = currentMode === 'signup' ? 'Sign In' : 'Sign Up';
    };

    const toggleMode = () => { currentMode = currentMode === 'signup' ? 'signin' : 'signup'; updateUIForMode(); };

    const showMessage = (message, type = 'success') => {
        messageBox.textContent = message;
        messageBox.className = `message-box ${type} show`;
        setTimeout(() => messageBox.classList.remove('show'), 3000);
    };

    async function hashPassword(string) {
        const utf8 = new TextEncoder().encode(string);
        const hashBuffer = await crypto.subtle.digest('SHA-256', utf8);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    const validateForm = () => {
        Object.values(errorDivs).forEach(div => div.style.display = 'none');
        let isValid = true;
        if (!regex.userid.test(useridInput.value)) { errorDivs.userid.textContent = 'User ID must be in the format 21MIS1128.'; errorDivs.userid.style.display='block'; isValid=false; }
        if (currentMode === 'signup') {
            if(usernameInput.value.length<3){ errorDivs.username.textContent='Username must be at least 3 chars'; errorDivs.username.style.display='block'; isValid=false; }
            if(!regex.email.test(emailInput.value)){ errorDivs.email.textContent='Email must end with @vitstudent.ac.in'; errorDivs.email.style.display='block'; isValid=false; }
            if(!regex.password.test(passwordInput.value)){ errorDivs.password.textContent='Password invalid'; errorDivs.password.style.display='block'; isValid=false; }
            if(passwordInput.value!==confirmPasswordInput.value){ errorDivs.confirmPassword.textContent='Passwords do not match'; errorDivs.confirmPassword.style.display='block'; isValid=false; }
        } else if(currentMode==='signin' && !passwordInput.value){ errorDivs.password.textContent='Password required'; errorDivs.password.style.display='block'; isValid=false; }
        return isValid;
    };

    const handleSignUp = async () => {
        const userId = useridInput.value;
        const hashedPassword = await hashPassword(passwordInput.value);

        try {
            const res = await fetch('http://localhost:3000/signup', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({userId, username:usernameInput.value,email:emailInput.value,passwordHash:hashedPassword})
            });
            const data = await res.json();
            if(!res.ok){ showMessage(data.message,'error'); return; }
            showMessage('Account created successfully! Redirecting...', 'success');
            localStorage.setItem('uniagent_user',JSON.stringify({userId,username:usernameInput.value}));
            setTimeout(()=>window.location.href='chat.html',1500);
        } catch(e){ console.error(e); showMessage('Server error','error'); }
    };

    const handleSignIn = async () => {
        const userId = useridInput.value;
        const hashedPassword = await hashPassword(passwordInput.value);
        try {
            const res = await fetch('http://localhost:3000/signin', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({userId,passwordHash:hashedPassword})
            });
            const data = await res.json();
            if(!res.ok){ showMessage(data.message,'error'); return; }
            showMessage('Signed in successfully! Redirecting...', 'success');
            localStorage.setItem('uniagent_user',JSON.stringify({userId,username:data.username}));
            setTimeout(()=>window.location.href='chat.html',1500);
        } catch(e){ console.error(e); showMessage('Server error','error'); }
    };

    form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        submitBtn.disabled = true;
        submitBtn.textContent = 'Processing...';
        if(validateForm()){ 
            if(currentMode==='signup') await handleSignUp();
            else await handleSignIn();
        }
        submitBtn.disabled=false;
        updateUIForMode();
    });

    modeToggleButton.addEventListener('click', toggleMode);
    updateUIForMode();
});
</script>
</body>
</html>
